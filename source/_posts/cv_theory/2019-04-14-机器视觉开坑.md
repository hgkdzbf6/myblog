---
layout: post
title:  "机器视觉开坑啦"
date:   2019-04-14 18:54:51 +0800
categories: cv
---

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

还是感觉cv有意思，但是感觉自己学习遇到了一些瓶颈。

所以开了一座深坑：机器视觉。

参考内容在[这里](https://courses.engr.illinois.edu/cs543/sp2015/)

## 第一章 cv介绍

输入深度图，构建出原来的模型形状，然后匹配，并且预测模型形状。

从图片当中恢复三维结构和内容，比如一堆小方块是一张床

从rgbd图像当中对3d场景建模

增强现实的东西。

目的：使得计算机理解图像和视频，

这是怎样的场景
车在哪里
我们离建筑物有多远

视觉问题很难，那是个象还是王后？

应用广泛：安全，健康，安保，生活，娱乐，访问其他网站。

谷歌地球。从成千上万张图片当中重建物体。OCR，数字，车牌识别。人脸检测，笑脸快门。

超市里面的物体识别。

基于视觉的生物识别技术，虹膜识别？

指纹识别，人脸识别。手机上面的物体识别。

电影里面拍照片，对人头进行建模。

运动捕捉。

判断有没有越位。

自动驾驶。

kinect体感游戏

空间视觉。

工业机器人，拧紧扳手。

移动机器人，比赛，真人机器人。

医学图像，基于图像的外科手术。

**不要从网上复制代码，除非你获得允许，如果不确定的话，去问**

从课上能够获得什么？
- 宽广的知识面：几何学，图像处理，识别，多视角，视频
- 是使你钻研的更深的背景
- 实践经验
- 很多工作，很难的材料，但是应该能学到很多。

话题：
- 解释强度
   - 怎么决定一个像素点的亮度和颜色？
   - 如何使用图像滤波器来提取有用的信息
- 响应和对齐
   - 如何找到场景当中物体对应的点
   - 如何估计两个物体之间的旋转
- 透视和三维重建
   - 3d世界如何映射到2d
   - 如何从视频或者图像中恢复出3d坐标
- 分组和分段
   - 如何把像素划分成有意义的区域
- 分类和物体检测
   - 如何表示图像，并且分类
   - 如何识别一个物体的类别
- 其他话题
   - 动作识别，3d场景和内容，CNN

需要知识：线性代数，基础代数，概率论。

最大化学习效率。

## 光和影子

光是怎样被记录的？光源照射在物体上，反射的光通过成像系统到成像平面。

两种数码成像元件：CCD，CMOS

原始的图像被映射到传感器平面。

光栅值，就是像素矩阵。
什么决定了像素强度？
我们可以从像素强度当中推测出场景的什么信息？

影响因素：
- 光源强度
- 表面几何形状
- 表面材质
- 附近表面
- 相机增益/曝光强度

镜面反射(specular reflection)和漫反射(diffuse reflection)

lambertian反射模型

有些光被吸收了，返照率ρ的函数。
剩下的光被分散了（漫反射）

matte磨砂paint，软布，混凝土

漫反射：lambert余弦辐射体。

如果垂直表面入射，强度为
$$
I_{0}=\frac{I d \Omega d A}{d \Omega_{0} d A_{0}}
$$

如果存在一个观测角度的话。
$$
I_{0}=\frac{I \cos (\theta) d \Omega d A}{d \Omega_{0} \cos (\theta) d A_{0}}=\frac{I d \Omega d A}{d \Omega_{0} d A_{0}}
$$

楔子大小：$$d\Omega$$
小孔区域：$$dA$$

发光强度的空间分布符合余弦定理的发光体（不论是自发光还是反射光），在不同角度的辐射强度会随着余弦公式变化，角度越大强度越弱。

强度不依赖与观察者的视角，而是依赖于反射光的强度，和从反光体表面来看的视角的cos。

镜面反射依赖光的朝向平面的法向量。比如镜子是全镜面反射。
大多数物体的表面都是漫反射和镜面反射的混合。
镜面性：镜面反射占主导地位，比如干净的木地板，儿童玩具球。

强度依赖于照明角度，因为斜的角度会导致更少的光。

albedo：阳光反射的比例，$$\rho$$
S: 光源向量
N: 平面法向量
I: 反射强度

所以有：

$$I(x) = \rho(x)(S\cdotN(x))$$

比如建筑物的亮面和暗面。

当光照射到一个普通表面时：
- 有些光被吸收了(1-ρ)，低的反射率的话，就有更多的被吸收
- 有些光被漫反射了（和视角方向无关）
- 有些光镜面反射了（像镜子一样），依赖于视角方向。

其他可能的效应：
透传
折射
荧光：（fluorescence）是一种光致冷发光现象。当某种常温物质经某种波长的入射光（通常是紫外线或X射线）照射，吸收光能后进入激发态，并且立即退激发并发出出射光（通常波长比入射光的的波长长，在可见光波段）；而且一旦停止入射光，发光现象也随之立即消失。具有这种性质的出射光就被称之为荧光。一般以持续发光时间来分辨荧光或磷光，持续发光时间短于10-8秒的称为荧光，持续发光时间长于10-8秒的称为磷光(phosphorescence)。

次表面散射，Subsurface scattering：是光在传播时的一种现象，表现为光在穿过透明物体表面后，与材料之间发生交互作用而导致光被散射开来，光路也在其他的位置穿出物体。光一般会穿透物体的表面，在物体内部在不同的角度被反射若干次，最终穿出物体。次表面散射在三维计算机图形中十分重要，可用来渲染大理石、皮肤、树叶、蜡、牛奶等多种不同材料。

BRDF：双向反射率分布函数
Bidirectional Reflectance Distribution Function。

本地反射建模，告诉我们，当从一个方向看从另一个方向发出的光的时候，一个平面多亮。

$$
\rho\left(\theta_{i}, \phi_{i}, \theta_{e}, \phi_{e} ; \lambda\right)=\frac{\mathrm{L}_{\mathrm{e}}\left(\theta_{\mathrm{e}}, \phi_{\mathrm{e}}\right)}{\mathrm{E}_{\mathrm{i}}\left(\theta_{\mathrm{i}}, \phi_{\mathrm{i}}\right)}=\frac{\mathrm{L}_{\mathrm{e}}\left(\theta_{\mathrm{e}}, \phi_{\mathrm{e}}\right)}{\mathrm{L}_{\mathrm{i}}\left(\theta_{\mathrm{i}}, \phi_{\mathrm{i}}\right) \cos \theta_{\mathrm{i}} \mathrm{d} \omega}
$$

应用：光度立体重建。

假定：
- 一个点集的来源，有无穷的距离
- 一个物体的一些图片的集合，包含相同的相机参数和物体配置，但是使用不同的光源。
- 一个朗博物体Lambertian（或者镜面反射的部分已经被移除了）

每个图片都是：$$I_{i}(x)={S}_{i} \cdot(p(x) N(x))$$

$$S_i$$是来源i的向量，包括强度和方向
$$I_i$$是像素x的强度。

如果有足够多的图像，而且他们的光源是已知的，我们可以解出：
$$
B(x)=p(x) N(x)
$$

反射率也可以给出：
$$
p(x)=\sqrt{B(x) \cdot B(x)}
$$

动态范围和相机响应。

典型场景有很大的动态范围
相机响应一般是线性的（15-240）但是在极端情况下表现非线性，表现为饱和或者欠饱和。

颜色的话是可见光光谱构成的。

人眼对绿光相对敏感？

红宝石激光的光谱：700nm波长很高
普通日光：400-700nm都有，蓝光可能还高一点。
磷化镓晶体:主要是黄色。
灯泡：红光多一点。

光谱响应曲线。

有色光到达相机的时候，带来两个效应:
- 光的颜色
- 物体表面的颜色

拜耳滤色镜，是一种将RGB滤色器排列在光传感组件方格之上所形成的马赛克彩色滤色阵列。数字相机、录影器、扫描仪等使用的单片机数字图像传感器大多数用这种特定排列的滤色阵列来制作彩色影像。这种滤色器的排列[注 2]有50%是绿色，25%是红色，另外25%是蓝色，因此也称做RGBG ，GRGB ，或者RGGB。

有序抖动法？递归定义矩阵。

绿色光传感器称作光敏侦测组件，而红、蓝色则称为色敏侦测组件。

他使用两倍于红色或蓝色的绿色组件来模仿人眼的生理性质。人类视网膜白天同时使用了M与L视锥细胞来感光，对绿光最敏感。

这些组件称作感应组件、像素感应器、感应单元格（sensel）或简单像素等。被它们感应侦测到取样数值后，使用插值（Interpolation）形成影像像素。

拜尔滤色镜相机的原始图像文件称作拜尔图像影像。因为每个像素只过滤并记录RGB三种颜色的一种，这些从单个像素获取的信息并不能完整表现红、绿、蓝各色的组成数值。为了得到全色彩影像，可用不同的去马赛克算法来插值得到每个像素的红、绿、蓝色的组成数值。这些算法利用周围相同颜色的像素去估计一个特定像素的组成数值。

算法运算量需求不同，最后成像的质量也有差异。数字相机自身能产生JPEG或是TIFF影像，不用数字相机而直接使用感应组件也能进行此操作。

去马赛克有不同的实现方法。一些简单的方式是对相邻同色的像素数值进内联插。举例来说，当芯片曝光得到一张影像后，每个像素就可以读取出来。绿色过滤器的像素精确测量了绿色成分，而该像素红色和蓝色的成分则是从邻区获取。一个绿色像素的红色数值可由相邻两个红色像素内插计算出来；同样的，内插相邻两个蓝色像素也能计算出蓝色数值。

拜尔滤色镜几乎用于全世界的消费性数字相机。

通过一个图像，得到偏移，然后得到RGB三个通道的图像。

所以为什么光是一个光谱，图像却是RGB呢？

长，中，短的视锥细胞，加上强度的杆细胞。
长的和中等的在X染色体上，这就是为什么男的更容易患红绿色盲。
红的有很大的变化，所以女的更有可能有四色视觉。
ps:四色视觉（英语：Tetrachromacy）是指生物体拥有四种独立的感光通道，或指眼球中有四种感色的视锥细胞(较人类多出感应紫外线的锥状细胞)，大部分鸟类具有此种特征。一般人类所绘制出的图案对四色视觉者可能是难以理解的。

有的动物有1（夜行性动物）2（狗）4（鱼，鸟），5（鸽子，某些爬行动物，两栖动物），甚至12种（螳螂虾，皮皮虾）视锥细胞。

现在，光从物体表面到达了相机。
叫做本地照明模型，
但是更多的光是从周围表面来的。

互相反射是光的主要来源
互相反射也会影响物体表面的颜色

场景表面也会引起阴影。
阴影：因为光源被遮挡，引起了强度的减弱。

penumbra(半影)
umbra(本影)

点光源产生的阴影
面光源产生的阴影
参考

![这里](/assets/cv/cv_影子.png)

其中，1是没有阴影，2是半影，3是本影

光源模型：
- 距离点光源，只有一个照明方向，比如说太阳
- 面光源：白墙，天空，漫反射台灯
- 周围ambient光源：代替互相反射的光源
- 全局照明模型：考虑建模场景当中的互相反射

总结：可能的影响因素：反照率，阴影，纹理，镜面反射，曲率(curvature)，光照方向。

每个像素的亮度值告诉我们什么？
- 光源（强度，方向，颜色）
- 表面朝向
- 表面材质和反照率
- 从周围表面反射的光和阴影
- 传感器增益

单个像素的亮度没有告诉我们什么东西，比如
![这张图片](/assets/cv/cv_pixel_value.png)

现在可以解释图片是什么了：
- 关键：从场景的周围点来看，大多数的特征没有什么变化
- 信息大部分只在亮度变化的地方产生。

暗度：临近像素之间大的差异。

强度告诉我们形状的什么信息：
- 物体平面法向量的变化
- 纹理
- 接近(proximity)
- 凹痕和凸起indents and bumps
- 凹槽和折痕(grooves and creases)

影子是一个线索

明暗界限：terminator

人类擅长解释物体表面的反照率，或者真实颜色，而不是观测颜色强度。

本地比较，离着很远的物体，人类感觉到他们的颜色会有差异，但是他们的颜色是一样的。

**颜色校正**（这个面试题考过）
简单的想法，对RGB三个通道，每个通道乘以一个数值。

$$
\left[ \begin{array}{c}{\tilde{r}} \\ {\tilde{g}} \\ {\tilde{b}}\end{array}\right]=\left[ \begin{array}{ccc}{\alpha_{r}} & {0} & {0} \\ {0} & {\alpha_{g}} & {0} \\ {0} & {0} & {\alpha_{b}}\end{array}\right] \left[ \begin{array}{l}{r} \\ {g} \\ {b}\end{array}\right]
$$

如何选择这些常数？
1. 白世界假设：物体最亮的颜色是白色（用这个值来除以最大的值）
2. 灰世界假设：平均值应该是灰色的。也就是说，对每一个r通道，乘以

   $$
   \frac {\operatorname{avg}(\mathrm{r}) * 3}{ \operatorname{avg}((\mathrm{r}+\mathrm{g}+\mathrm{b})}
   $$

3. 白平衡：选择一个颜色为白色或者是灰色。

总结：
重要术语：
- 漫反射
- 镜面反射
- 反照率
- 半影
- 本影

观测强度依赖于光源，反射平面的几何形状和材质，周围物体以及相机参数。

物体之间也会投射光和影

强度的不同是形状的主要线索。

下一节：图像滤波器。